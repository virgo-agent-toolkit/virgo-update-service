#!/usr/bin/env node

var fs = require('fs');
var _ = require('underscore');
var argv = require('yargs')
  .usage('virgo-update-service')
  .alias('c', 'config')
  .describe('c', 'load config')
  .alias('p', 'peers')
  .describe('p', 'etcd peers')
  .alias('b', 'bind-addr')
  .describe('b', 'bind address')
  .alias('r', 'addr')
  .describe('r', 'register service as host:port')
  .alias('a', 'api-key')
  .describe('a', 'api key')
  .alias('u', 'username')
  .describe('u', 'username')
  .alias('s', 'secret')
  .describe('s', 'secret')
  .alias('t', 'htpasswd')
  .describe('t', 'the htpassword filepath')
  .alias('n', 'service-name')
  .describe('n', 'the service name')
  .argv;

var entry = require('../lib/entry').entry;
var log = require('logmagic').local('virgo-upgrade-service');

var default_options = {
  pkgcloud: { provider: 'rackspace' },
  secret: '',
  data_dir: '/tmp/data',
  exe_dir: '/tmp/deploy',
  service_name: 'virgo-upgrade-service',
  addr_host: null,
  addr_port: null,
  bind_host: '127.0.0.1',
  bind_port: 34000
};

var options = {};
if (argv.c) {
  try {
    options = JSON.parse(fs.readFileSync(argv.c));
  } catch (err) {
    log.error('Error parsing config.', {err: err});
    process.exit(1);
  }
}

// merge in the default options
options = _.defaults(options, default_options);
options.argv = argv;

entry(options);
