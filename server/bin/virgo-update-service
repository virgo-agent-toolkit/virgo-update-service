#!/usr/bin/env node

var fs = require('fs');
var _ = require('underscore');
var argv = require('optimist')
  .usage('virgo-update-service')
  .alias('c', 'config')
  .describe('c', 'load config')
  .alias('p', 'peers')
  .describe('p', 'etcd peers')
  .alias('b', 'bind-addr')
  .describe('b', 'bind address')
  .alias('a', 'api-key')
  .describe('a', 'api key')
  .alias('u', 'username')
  .describe('u', 'username')
  .alias('s', 'secret')
  .describe('s', 'secret')
  .argv;

var entry = require('../lib/entry').entry;
var logger = require('../lib/logger').logger;

var default_options = {
  pkgcloud: { provider: 'rackspace' },
  secret: '',
  data_dir: '/var/data',
  exe_dir: '/var/deploy',
  service_name: 'virgo-upgrade-service',
  listen_host: '127.0.0.1',
  listen_port: 34000
};

var options = {};
if (argv.c) {
  try {
    options = JSON.parse(fs.readFileSync(argv.c));
  } catch (err) {
    logger.error('Error parsing config.', {error: err});
    process.exit(1);
  }
}

// merge in the default options
options = _.defaults(options, default_options);
options.argv = argv;

entry(options);
